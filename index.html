<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voc'Boost</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f4f6fb;
      --card: #ffffff;
      --card-strong: #f8fafc;
      --text: #0f172a;
      --muted: #475569;
      --accent: #2563eb;
      --accent-2: #22c55e;
      --success: #16a34a;
      --warning: #f59e0b;
      --error: #dc2626;
      --border: #e2e8f0;
      --shadow: 0 15px 40px rgba(15, 23, 42, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 12% 18%, rgba(37, 99, 235, 0.16), transparent 28%),
                  radial-gradient(circle at 82% 8%, rgba(34, 197, 94, 0.18), transparent 26%),
                  linear-gradient(140deg, #eef2ff, #f8fafc 50%, #e0f2fe);
      color: var(--text);
      min-height: 100vh;
    }

    .app-shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 20px 80px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
    }

    .logo {
      font-weight: 700;
      font-size: 22px;
      letter-spacing: 0.5px;
      padding: 10px 14px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.12), rgba(34, 197, 94, 0.14));
      border: 1px solid #dbeafe;
      box-shadow: var(--shadow);
    }

    .tabs {
      display: inline-flex;
      background: #e2e8f0;
      border: 1px solid #cbd5e1;
      border-radius: 14px;
      padding: 4px;
      gap: 6px;
      box-shadow: var(--shadow);
    }

    .tab-btn {
      border: none;
      background: transparent;
      color: var(--text);
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
      letter-spacing: 0.2px;
    }

    .tab-btn.active {
      background: #ffffff;
      color: var(--accent);
      box-shadow: 0 10px 30px rgba(37, 99, 235, 0.18);
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 20px;
      margin-bottom: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }

    .card-compact {
      padding: 14px 16px;
    }

    .card-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 1.1px;
      font-size: 12px;
      color: var(--muted);
      margin: 0;
    }

    h1 {
      margin: 8px 0 2px;
      font-size: 28px;
      letter-spacing: 0.4px;
    }

    h2 {
      margin: 0;
      font-size: 22px;
    }

    h3 {
      margin: 0;
      font-size: 20px;
    }

    p { margin: 0; }

    .muted { color: var(--muted); }

    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.12);
      color: #1d4ed8;
      border: 1px solid rgba(37, 99, 235, 0.25);
      font-weight: 600;
      font-size: 13px;
      letter-spacing: 0.2px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    label {
      font-weight: 600;
      color: #e5e7eb;
      letter-spacing: 0.2px;
    }

    input[type="text"], select, textarea {
      background: #f8fafc;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 12px;
      font-size: 15px;
      transition: border 0.2s ease, transform 0.1s ease;
    }

    input[type="text"]:focus, select:focus, textarea:focus {
      outline: none;
      border-color: rgba(56, 189, 248, 0.5);
      transform: translateY(-1px);
    }

    textarea { min-height: 140px; resize: vertical; }

    .btn {
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 700;
      color: #ffffff;
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      cursor: pointer;
      box-shadow: 0 15px 40px rgba(56, 189, 248, 0.35);
      transition: transform 0.15s ease, box-shadow 0.2s ease, filter 0.2s ease;
      letter-spacing: 0.3px;
    }

    .btn:hover { transform: translateY(-1px); filter: brightness(1.04); }
    .btn:active { transform: translateY(0); box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3); }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; box-shadow: none; }

    .btn.secondary {
      background: #e2e8f0;
      color: var(--text);
      box-shadow: none;
      border: 1px solid #cbd5e1;
    }

    .btn.danger { background: linear-gradient(135deg, #f97316, #ef4444); color: #fff; box-shadow: 0 14px 36px rgba(239, 68, 68, 0.22); }

    .button-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      gap: 10px;
    }

    .list-item:last-child { border-bottom: none; }

    .list-meta { display: flex; align-items: center; gap: 10px; }

    .badge {
      background: rgba(255, 255, 255, 0.08);
      padding: 6px 10px;
      border-radius: 8px;
      color: #e5e7eb;
      font-weight: 600;
      font-size: 13px;
    }

    .word-selection {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 10px;
    }

    .word-card {
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card-strong);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      transition: border 0.2s ease, transform 0.15s ease;
    }

    .word-card.note-easy { border-color: #16a34a; box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.18); background: rgba(22, 163, 74, 0.08); }
    .word-card.note-hard { border-color: #dc2626; box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.18); background: rgba(220, 38, 38, 0.08); }

    .word-card:hover { border-color: rgba(56, 189, 248, 0.35); transform: translateY(-1px); }

    .word-text { flex: 1; }
    .word-text .german { font-weight: 700; }
    .word-text .french { color: var(--muted); font-size: 14px; }

    .chip-group { display: flex; gap: 6px; }
    .tag-dots { display: flex; gap: 6px; margin-top: 6px; }
    .tag-dot { 
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      padding: 0;
      background: #e5e7eb;
      transition: transform 0.15s ease, border 0.15s ease, box-shadow 0.15s ease;
    }
    .tag-dot:hover { transform: translateY(-1px); }
    .tag-dot.active { box-shadow: 0 0 0 2px rgba(0,0,0,0.1); transform: scale(1.25); border-color: rgba(0,0,0,0.12); }
    .tag-blue { background: #38bdf8; }
    .tag-pink { background: #f472b6; }
    .tag-green { background: #34d399; }
    .tag-red { background: #f87171; }
    .tag-blue.active { border-color: #0ea5e9; }
    .tag-pink.active { border-color: #ec4899; }
    .tag-green.active { border-color: #22c55e; }
    .tag-red.active { border-color: #ef4444; }
    .hidden { display: none !important; }

    .chip {
      border: 1px solid var(--border);
      background: rgba(37, 99, 235, 0.08);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.2px;
      transition: background 0.2s ease, border 0.2s ease, transform 0.12s ease;
    }

    .chip:hover { border-color: rgba(37, 99, 235, 0.3); transform: translateY(-1px); }
    .chip.active { background: #1d4ed8; border-color: #1d4ed8; color: #fff; box-shadow: 0 8px 18px rgba(29, 78, 216, 0.25); }
    .subtext { color: var(--muted); font-size: 14px; margin-top: 4px; }

    .divider { height: 1px; background: var(--border); margin: 14px 0; }

    .progress-shell {
      width: 100%;
      background: #eef2ff;
      border: 1px solid #dbeafe;
      border-radius: 999px;
      height: 12px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      transition: width 0.3s ease;
    }

    .progress-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; color: var(--muted); font-weight: 600; }

    .game-card { margin-top: 10px; }

    .word-display { font-size: 28px; font-weight: 700; margin: 12px 0; }

    .assembled {
      min-height: 50px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 14px;
      font-size: 20px;
      letter-spacing: 1.2px;
      background: rgba(255, 255, 255, 0.04);
    }

    .chunk-buttons, .letter-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 8px;
      margin: 12px 0;
    }

    .chunk-btn, .letter-btn {
      border: 1px solid var(--border);
      background: #eef2ff;
      color: var(--text);
      padding: 12px 10px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 22px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .chunk-btn:hover, .letter-btn:hover { border-color: rgba(37, 99, 235, 0.4); transform: translateY(-1px); }
    .chunk-btn.used, .letter-btn.used { opacity: 0.4; filter: grayscale(0.3); transform: none; }

    .step-dots { display: flex; gap: 6px; flex-wrap: wrap; }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e2e8f0;
      border: 1px solid var(--border);
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .dot.done { background: rgba(34, 197, 94, 0.8); transform: scale(1.05); }
    .dot.current { background: rgba(37, 99, 235, 0.8); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.12); }
    .dot.success { background: rgba(34, 197, 94, 0.9); }
    .dot.error { background: rgba(220, 38, 38, 0.85); }

    .feedback { color: var(--muted); margin-top: 6px; min-height: 22px; }
    .feedback.error { color: #b91c1c; }
    .feedback.success { color: #166534; }

    .final-screen { text-align: center; padding: 26px 22px; }
    .trophy { font-size: 80px; margin-bottom: 10px; }

    .inline-help { color: var(--muted); font-size: 13px; margin-top: 4px; }

    @media (max-width: 720px) {
      .app-shell { padding: 16px 14px 60px; }
      .topbar { flex-direction: column; align-items: flex-start; }
      .tabs { width: 100%; }
      .tab-btn { flex: 1; text-align: center; }
      .word-selection { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
      .button-row { width: 100%; }
      .button-row .btn { flex: 1; justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="topbar">
      <div class="logo">Voc'Boost</div>
      <div class="tabs">
        <a class="tab-btn" data-tab="teacher" href="teacher.html">Espace prof</a>
        <button class="tab-btn active" data-tab="student" type="button">Espace √©l√®ve</button>
      </div>
    </header>

    <main>
      <section id="teacher" class="tab-panel">
        <div class="card card-compact" id="teacher-locked-card">
          <div class="card-title">
            <div>
              <p class="eyebrow">Acc√®s restreint</p>
              <h2>D√©verrouiller l'espace prof</h2>
              <p class="muted">Prot√©gez la cr√©ation/√©dition. Code par d√©faut : <strong>prof</strong>.</p>
            </div>
          </div>
          <div class="field">
            <label for="teacher-code-input">Code prof</label>
            <div class="button-row" style="gap:8px; flex-wrap:wrap;">
              <input type="password" id="teacher-code-input" placeholder="Entrer le code" style="flex:1; min-width:180px;" />
              <button class="btn" id="unlock-teacher" type="button">D√©verrouiller</button>
            </div>
          </div>
          <p class="muted" id="teacher-lock-status"></p>
        </div>

        <div id="teacher-content" style="display:none;">
          <div class="card">
            <div class="card-title">
              <div>
                <p class="eyebrow">Configuration</p>
                <h2>Cr√©er une liste</h2>
                <p class="muted">Collez un tableau (Excel/Sheets) : une colonne fran√ßais, une colonne allemand.</p>
              </div>
              <div class="pill">Prof</div>
            </div>
            <div class="field">
              <label for="list-name">Nom de la liste</label>
              <input type="text" id="list-name" placeholder="Ex: 9H - Voc 1" />
            </div>
            <div class="field">
              <label for="folder-name">Dossier / classe</label>
              <input type="text" id="folder-name" placeholder="Ex: 9H, 10H, R√©vision" />
              <div class="inline-help">Les dossiers aident les √©l√®ves √† retrouver les listes.</div>
            </div>
            <div class="field">
              <label for="list-raw">Liste (une ligne par mot, s√©parateur tabulation, point-virgule ou virgule)</label>
              <textarea id="list-raw" placeholder="fran√ßais;allemand"></textarea>
              <div class="inline-help">Exemple : <code>l'√©cole	 die Schule</code> ou <code>l'√©cole;die Schule</code>.</div>
            </div>
            <div class="button-row">
              <button class="btn" id="save-list">Enregistrer la liste</button>
              <button class="btn secondary" id="reset-form">Effacer</button>
              <button class="btn secondary" id="cancel-edit" style="display:none;">Annuler l'√©dition</button>
            </div>
            <p class="muted" id="edit-status"></p>
          </div>

          <div class="card">
            <div class="card-title">
              <div>
                <p class="eyebrow">Vos listes</p>
                <h3>Listes disponibles</h3>
              </div>
              <button class="btn secondary" id="lock-teacher" type="button">Verrouiller</button>
            </div>
            <div id="existing-lists"></div>
            <div class="divider"></div>
            <div class="field">
              <label>Synchronisation GitHub (lecture/√©criture du fichier JSON)</label>
              <div class="button-row" style="gap:8px; flex-wrap:wrap;">
                <input type="text" id="github-owner" placeholder="Utilisateur/Organisation" style="flex:1; min-width:160px;">
                <input type="text" id="github-repo" placeholder="Nom du d√©p√¥t" style="flex:1; min-width:160px;">
              </div>
              <div class="button-row" style="gap:8px; flex-wrap:wrap; margin-top:8px;">
                <input type="text" id="github-branch" placeholder="Branche (ex: main)" style="flex:1; min-width:140px;">
                <input type="text" id="github-path" placeholder="Chemin du JSON (ex: lists.json)" style="flex:1; min-width:160px;">
              </div>
              <div class="button-row" style="gap:8px; flex-wrap:wrap; margin-top:8px;">
                <input type="password" id="github-token" placeholder="Token GitHub (√©criture)" style="flex:1; min-width:200px;">
              </div>
              <div class="inline-help">Le token n'est stock√© qu'en local (localStorage). Requis uniquement pour √©crire sur GitHub.</div>
            </div>
            <div class="button-row" style="gap:8px; flex-wrap:wrap; margin-top:8px;">
              <button class="btn secondary" id="save-github-config" type="button">Sauvegarder la config</button>
              <button class="btn secondary" id="refresh-remote" type="button">Rafra√Æchir depuis GitHub</button>
              <button class="btn secondary" id="download-json" type="button">T√©l√©charger lists.json</button>
            </div>
            <div class="inline-help">Sans token, cliquez sur ‚ÄúT√©l√©charger‚Äù puis uploadez/committez <code>lists.json</code> dans le d√©p√¥t pour partager aux √©l√®ves.</div>
            <p class="muted" id="sync-status"></p>
          </div>
        </div>
      </section>

      <section id="student" class="tab-panel active">
        <div class="card" id="selection-card">
          <div class="card-title">
            <div>
              <p class="eyebrow">√âl√®ve</p>
              <h2>Choisis ta liste</h2>
              <p class="muted">Active = √† revoir en passif + actif. Passif = seulement le premier tour.</p>
            </div>
            <div class="pill">Nouveau</div>
          </div>
          <div class="field">
            <label for="folder-filter">Dossier</label>
            <select id="folder-filter"></select>
          </div>
          <div class="field">
            <label for="list-selector">Liste</label>
            <select id="list-selector"></select>
            <div class="inline-help" id="list-meta"></div>
          </div>
          <div class="button-row" style="margin-bottom:8px; flex-wrap: wrap;">
            <button class="btn" id="start-learning" type="button">Lancer l'entra√Ænement</button>
            <button class="btn secondary" id="clear-selection" type="button">Tout d√©s√©lectionner</button>
            <button class="btn secondary" id="toggle-colors" type="button" style="padding:10px 12px; min-width:42px;">üé®</button>
            <div class="tag-dots hidden" id="global-tags" style="margin-left:auto; gap:8px;">
              <button class="tag-dot tag-blue" data-tag="blue" title="Bleu"></button>
              <button class="tag-dot tag-pink" data-tag="pink" title="Rose"></button>
              <button class="tag-dot tag-green" data-tag="green" title="Vert"></button>
              <button class="tag-dot tag-red" data-tag="red" title="Rouge"></button>
              <button class="tag-dot" data-tag="black" title="Noir"></button>
            </div>
          </div>
          <p class="muted">Clique sur Passif/Actif pour s√©lectionner. Minimum 4 mots.</p>
          <div id="selection-counter" class="muted" style="font-weight:600; margin:4px 0 10px;"></div>
          <div class="divider"></div>
          <div class="word-selection" id="word-selection"></div>
        </div>

        <div id="passive-screen" class="card game-card" style="display:none;">
          <div class="card-title">
            <div>
              <p class="eyebrow">Phase 1</p>
              <h3>Apprentissage passif</h3>
            </div>
            <div class="button-row">
              <button class="btn secondary" id="back-to-list-passive">Quitter</button>
            </div>
          </div>
          <div class="progress-label">
            <span id="passive-step-label"></span>
            <span id="passive-count"></span>
          </div>
          <div class="progress-shell"><div class="progress-fill" id="passive-progress"></div></div>
          <div class="step-dots" id="passive-dots"></div>
          <div class="word-display" id="german-word"></div>
          <div class="muted">Compose la traduction en cliquant sur des blocs de 2-3 lettres. 3 intrus se cachent dedans.</div>
          <div class="assembled" id="assembled-passive"></div>
          <div class="chunk-buttons" id="chunk-buttons"></div>
          <div class="button-row">
            <button class="btn secondary" id="undo-chunk">Retirer le dernier bloc</button>
            <button class="btn" id="validate-passive">Valider</button>
          </div>
          <div class="feedback" id="passive-feedback"></div>
        </div>

        <div id="active-screen" class="card game-card" style="display:none;">
          <div class="card-title">
            <div>
              <p class="eyebrow">Phase 2</p>
              <h3>Apprentissage actif</h3>
            </div>
            <div class="button-row">
              <button class="btn secondary" id="back-to-list-active">Quitter</button>
            </div>
          </div>
          <div class="progress-label">
            <span id="active-step-label"></span>
            <span id="active-count"></span>
          </div>
          <div class="progress-shell"><div class="progress-fill" id="active-progress"></div></div>
          <div class="step-dots" id="active-dots"></div>
          <div class="word-display" id="french-word"></div>
          <div class="muted">Assemble le mot allemand lettre par lettre. Les espaces sont ajout√©s automatiquement.</div>
          <div class="assembled" id="assembled-active"></div>
          <div class="letter-buttons" id="letter-buttons"></div>
          <div class="button-row">
            <button class="btn secondary" id="erase-letter">Effacer</button>
            <button class="btn" id="validate-active">Valider</button>
          </div>
          <div class="feedback" id="active-feedback"></div>
        </div>

        <div id="final-screen" class="card final-screen" style="display:none;">
          <div class="trophy">üèÜ</div>
          <h2>Bravo !</h2>
          <p class="muted" id="final-message"></p>
          <p id="timer-result"></p>
          <div class="button-row" style="justify-content:center; margin-top:12px;">
            <button class="btn" id="restart">Revenir √† la s√©lection</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const STORAGE_KEY = 'voc-app-lists-v2';
    const PUBLISHED_KEY = 'voc-app-published-v1';
    const TEACHER_CODE_KEY = 'voc-app-teacher-code-v1';
    const NOTES_KEY = 'voc-app-notes-v1';
    const GITHUB_CONF_KEY = 'voc-app-github-conf-v1';

    const defaultWords = [
      { french: "l'√©cole", german: "die Schule" },
      { french: "les √©coles", german: "die Schulen" },
      { french: "nouveau-elle", german: "neu" },
      { french: "le ma√Ætre, le professeur, l'enseignant", german: "der Lehrer" },
      { french: "les ma√Ætres, les professeurs, les enseignants", german: "die Lehrer" },
      { french: "la ma√Ætresse, la professeur, l'enseignante", german: "die Lehrerin" },
      { french: "les ma√Ætresses, les professeurs, les enseignantes", german: "die Lehrerinnen" },
      { french: "l'√©l√®ve", german: "der Sch√ºler" },
      { french: "les √©l√®ves", german: "die Sch√ºler" },
      { french: "l'√©l√®ve", german: "die Sch√ºlerin" },
      { french: "les √©l√®ves (filles)", german: "die Sch√ºlerinnen" },
      { french: "Quelle est ta mati√®re pr√©f√©r√©e ?", german: "Was ist dein Lieblingsfach?" },
      { french: "Comment peut-on dire cela en allemand ?", german: "Wie kann man das auf Deutsch sagen?" },
      { french: "Je ne comprends pas.", german: "Ich verstehe das nicht." },
      { french: "Pouvez-vous r√©p√©ter, s'il vous pla√Æt?", german: "K√∂nnen Sie das bitte wiederholen?" },
      { french: "Qui est-ce ?", german: "Wer ist das ?" },
      { french: "Qu'est-ce que c'est ?", german: "Was ist das?" },
      { french: "Pas des probl√®me !", german: "Kein Problem." },
      { french: "Puis-je aller aux toilettes ?", german: "Darf ich auf die Toilette?" },
      { french: "Quand... ?", german: "Wann‚Ä¶?" },
      { french: "C'est quand la r√©cr√©ation ?", german: "Wann ist Pause?" },
      { french: "Combien (de)... ?", german: "Wie viele...?" },
      { french: "Combien d'heures as-tu le lundi ?", german: "Wie viele Stunden hast du am Montag?" },
      { french: "Quelles langues parles-tu ?", german: "Welche Sprachen sprichst du?" },
      { french: "Je parle...", german: "Ich spreche..." },
      { french: "As-tu un animal domestique ?", german: "Hast du ein Haustier?" },
      { french: "Oui, j'ai un chien", german: "Ja, ich habe einen Hund" },
      { french: "Non, je n'en ai pas.", german: "Nein, ich habe kein Haustier." },
      { french: "les loisirs", german: "die Freizeit" },
      { french: "le hobby, le passe-temps", german: "das Hobby" },
      { french: "les hobbys, les passes-temps", german: "die Hobbys" },
      { french: "Quel est ton passe-temps ?", german: "Was ist dein Hobby?" },
      { french: "lire", german: "lesen" },
      { french: "il lit", german: "er liest" },
      { french: "dessiner", german: "zeichnen" },
      { french: "il dessine", german: "er zeichnet" },
      { french: "nager", german: "schwimmen" },
      { french: "il nage", german: "er schwimmt" },
      { french: "faire du cheval", german: "reiten" },
      { french: "il fait du cheval", german: "er reitet" },
      { french: "rencontrer des amis", german: "Freunde treffen" },
      { french: "il rencontre des amis", german: "er trifft Freunde" },
      { french: "jouer du piano", german: "Klavier spielen" },
      { french: "il joue du piano", german: "er spielt Klavier" },
      { french: "√©couter de la musique", german: "Musik h√∂ren" },
      { french: "il √©coute de la musique", german: "er h√∂rt Musik" },
      { french: "Quel est ton passe-temps pr√©f√©r√© ?", german: "Was ist dein Lieblingshobby?" },
      { french: "la semaine", german: "die Woche" },
      { french: "les semaines", german: "die Wochen" },
      { french: "lundi", german: "Montag" },
      { french: "mardi", german: "Dienstag" },
      { french: "mercredi", german: "Mittwoch" },
      { french: "jeudi", german: "Donnerstag" },
      { french: "vendredi", german: "Freitag" },
      { french: "samedi", german: "Samstag" },
      { french: "dimanche", german: "Sonntag" },
      { french: "Je joue au tennis le lundi.", german: "Am Montag spiele ich Tennis." },
      { french: "le week-end", german: "das Wochenende" },
      { french: "les week-ends", german: "die Wochenenden" },
      { french: "Quand as-tu du temps ?", german: "Wann hast du Zeit?" },
      { french: "Le week-end.", german: "Am Wochenende." },
      { french: "Le mardi.", german: "Am Dienstag." },
      { french: "L'apr√®s-midi.", german: "Am Nachmittag." },
      { french: "la classe", german: "die Klasse" },
      { french: "les classes", german: "die Klassen" },
      { french: "l'emploi du temps", german: "der Stundenplan" },
      { french: "les emplois du temps", german: "die Stundenpl√§ne" },
      { french: "la mati√®re, la branche", german: "das Fach" },
      { french: "la mati√®re, la branche", german: "die F√§cher" },
      { french: "la salle scolaire, la pi√®ce", german: "der Raum" },
      { french: "les salles scolaires, les pi√®ces", german: "die R√§ume" },
      { french: "la salle de classe", german: "das Klassenzimmer" },
      { french: "les salles de classe", german: "die Klassenzimmer" },
      { french: "la salle des professeurs", german: "das Lehrerzimmer" },
      { french: "les toilettes, les WC", german: "die Toiletten" },
      { french: "la piscine", german: "das Schwimmbad" },
      { french: "les piscines", german: "die Schwimmb√§der" },
      { french: "la biblioth√®que", german: "die Bibliothek" },
      { french: "les biblioth√®ques", german: "die Bibliotheken" },
      { french: "la cour de r√©cr√©ation", german: "der Pausenhof" },
      { french: "les cours de r√©cr√©ation", german: "die Pausenh√∂fe" },
      { french: "la cantine scolaire", german: "die Schulkantine" },
      { french: "les sciences naturelles", german: "die Naturwissenschaften" },
      { french: "enseigner", german: "unterrichten" },
      { french: "il enseigne", german: "er unterrichtet" },
      { french: "la salle de travaux manuels, l'atelier", german: "der Werkraum" },
      { french: "les salles de travaux manuels, les ateliers", german: "die Werkr√§ume" },
      { french: "la salle informatique", german: "der Computerraum" },
      { french: "les salles informatiques", german: "die Computerr√§ume" },
      { french: "la salle de biologie", german: "der Biologieraum" },
      { french: "les salles de biologie", german: "die Biologier√§ume" },
      { french: "la salle d'arts visuels", german: "der Kunstraum" },
      { french: "les salles d'arts visuels", german: "die Kunstr√§ume" },
      { french: "la salle de gym", german: "die Turnhalle" },
      { french: "les salle de gym", german: "die Turnhallen" },
      { french: "le bureau", german: "das B√ºro" },
      { french: "les bureaux", german: "die B√ºros" },
      { french: "O√π est la salle de biologie ?", german: "Wo ist der Biologieraum?" },
      { french: "Au rez-de-chauss√©e.", german: "Im Erdgeschoss." },
      { french: "Au premier √©tage.", german: "Im ersten Stock." },
      { french: "Au deuxi√®me √©tage.", german: "Im zweiten Stock." },
      { french: "le cuisinier", german: "der Koch" },
      { french: "les cuisiniers", german: "die K√∂che" },
      { french: "la cuisini√®re", german: "die K√∂chin" },
      { french: "les cuisini√®res", german: "die K√∂chinnen" },
      { french: "le directeur", german: "der Direktor" },
      { french: "les directeurs", german: "die Direktoren" },
      { french: "la directrice", german: "die Direktorin" },
      { french: "les directrices", german: "die Direktorinnen" },
      { french: "le secr√©taire", german: "der Sekret√§r" },
      { french: "les secr√©taires", german: "die Sekret√§re" },
      { french: "la secr√©taire", german: "die Sekret√§rin" },
      { french: "les secr√©taires (femmes)", german: "die Sekret√§rinnen" },
      { french: "le concierge", german: "der Hauswart" },
      { french: "les concierges", german: "die Hauswarte" },
      { french: "la concierge", german: "die Hausw√§rterin" },
      { french: "les concierges (femmes)", german: "die Hausw√§rterinnen" }
    ];

    const defaultList = { id: 'default-9h-voc1', name: '9H - Voc 1', folder: '9H', words: defaultWords };

    let teacherLists = [];
    let lists = [];
    let wordNotes = {};
    let currentListId = defaultList.id;
    let currentFolderFilter = 'all';
    let selectionState = new Map();

    let passiveWords = [];
    let activeWords = [];
    let passiveQueue = [];
    let activeQueue = [];
    let passiveResults = [];
    let activeResults = [];
    let passiveErrorThisRound = false;
    let activeErrorThisRound = false;
    let currentIndex = 0;
    let phase = 'idle';
    let chunkStack = [];
    let targetSanitized = '';
    let userChunkInput = '';
    let userLetterInput = '';
    let letterStack = [];
    let startTime = 0;
    let currentColorMode = null;
    let editingListId = null;
    let colorPaletteEnabled = false;
    let teacherUnlocked = false;
    let githubConfig = { owner: '', repo: '', branch: 'main', path: 'lists.json', token: '' };

    const teacherTab = document.getElementById('teacher');
    const studentTab = document.getElementById('student');
    const tabButtons = document.querySelectorAll('.tab-btn');

    const folderFilter = document.getElementById('folder-filter');
    const listSelector = document.getElementById('list-selector');
    const listMeta = document.getElementById('list-meta');
    const wordSelection = document.getElementById('word-selection');
    const startButton = document.getElementById('start-learning');
    const clearSelectionButton = document.getElementById('clear-selection');
    const toggleColorsButton = document.getElementById('toggle-colors');
    const globalTags = document.getElementById('global-tags');
    const selectionCounter = document.getElementById('selection-counter');
    const selectionCard = document.getElementById('selection-card');

    const passiveScreen = document.getElementById('passive-screen');
    const activeScreen = document.getElementById('active-screen');
    const finalScreen = document.getElementById('final-screen');
    const germanWordEl = document.getElementById('german-word');
    const assembledPassive = document.getElementById('assembled-passive');
    const chunkButtons = document.getElementById('chunk-buttons');
    const passiveFeedback = document.getElementById('passive-feedback');
    const passiveProgress = document.getElementById('passive-progress');
    const passiveDots = document.getElementById('passive-dots');
    const passiveCount = document.getElementById('passive-count');
    const passiveStepLabel = document.getElementById('passive-step-label');

    const activeFeedback = document.getElementById('active-feedback');
    const letterButtons = document.getElementById('letter-buttons');
    const assembledActive = document.getElementById('assembled-active');
    const frenchWordEl = document.getElementById('french-word');
    const activeProgress = document.getElementById('active-progress');
    const activeDots = document.getElementById('active-dots');
    const activeCount = document.getElementById('active-count');
    const activeStepLabel = document.getElementById('active-step-label');

    const timerResult = document.getElementById('timer-result');
    const finalMessage = document.getElementById('final-message');

    const listNameInput = document.getElementById('list-name');
    const folderInput = document.getElementById('folder-name');
    const listRawInput = document.getElementById('list-raw');
    const saveListButton = document.getElementById('save-list');
    const resetFormButton = document.getElementById('reset-form');
    const cancelEditButton = document.getElementById('cancel-edit');
    const editStatus = document.getElementById('edit-status');
    const existingListsEl = document.getElementById('existing-lists');
    const teacherLockedCard = document.getElementById('teacher-locked-card');
    const teacherContent = document.getElementById('teacher-content');
    const teacherCodeInput = document.getElementById('teacher-code-input');
    const unlockTeacherBtn = document.getElementById('unlock-teacher');
    const teacherLockStatus = document.getElementById('teacher-lock-status');
    const lockTeacherBtn = document.getElementById('lock-teacher');
    const refreshRemoteBtn = document.getElementById('refresh-remote');
    const syncStatus = document.getElementById('sync-status');
    const githubOwnerInput = document.getElementById('github-owner');
    const githubRepoInput = document.getElementById('github-repo');
    const githubBranchInput = document.getElementById('github-branch');
    const githubPathInput = document.getElementById('github-path');
    const githubTokenInput = document.getElementById('github-token');
    const saveGithubConfigBtn = document.getElementById('save-github-config');
    const downloadJsonBtn = document.getElementById('download-json');

    const alphabet = 'abcdefghijklmnopqrstuvwxyz√§√∂√º√ü';
    const alphabetExtended = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz√§√∂√º√ü ';

    function normalizeAnswer(str) {
      return str
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[\s'‚Äô\-.,;:!?]/g, '');
    }

    function cloneLists(data) {
      return JSON.parse(JSON.stringify(data || []));
    }

    function toBase64(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function chunkStringWithSpaces(str) {
      const chunks = [];
      let i = 0;
      while (i < str.length) {
        const remaining = str.length - i;
        let size = remaining % 3 === 1 ? 2 : 3;
        if (remaining <= 3) size = remaining;
        chunks.push(str.slice(i, i + size));
        i += size;
      }
      return chunks;
    }

    function randomChunk(len) {
      let res = '';
      for (let i = 0; i < len; i++) {
        res += alphabetExtended[Math.floor(Math.random() * alphabetExtended.length)];
      }
      return res;
    }

    function buildChunks(word) {
      const trimmed = word.trim();
      const chunks = chunkStringWithSpaces(trimmed);
      const options = [...chunks];
      while (options.length < chunks.length + 3) {
        const size = Math.random() > 0.5 ? 3 : 2;
        const candidate = randomChunk(size);
        if (!options.includes(candidate)) {
          options.push(candidate);
        }
      }
      return { targetRaw: trimmed, targetNormalized: normalizeAnswer(trimmed), options: shuffle(options) };
    }

    function buildLetters(word) {
      const raw = word.trim();
      const chars = Array.from(raw);
      const counts = {};
      chars.forEach((c) => {
        counts[c] = (counts[c] || 0) + 1;
      });
      const letters = [...chars];
      while (letters.length < chars.length + 3) {
        const intruder = alphabetExtended[Math.floor(Math.random() * alphabetExtended.length)];
        letters.push(intruder);
      }
      return { targetRaw: raw, targetNormalized: normalizeAnswer(raw), letters: shuffle(letters), counts };
    }

    function ensureDefaultPresence(arr) {
      const hasDefault = arr.find((l) => l.id === defaultList.id);
      if (!hasDefault) {
        return [defaultList, ...arr];
      }
      return arr;
    }

    function safeParse(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch (e) {
        console.warn('Impossible de lire', key, e);
        localStorage.removeItem(key);
        return fallback;
      }
    }

    function loadTeacherLists() {
      teacherLists = safeParse(STORAGE_KEY, []);
      // Si l'utilisateur a cr√©√© des listes via teacher.html (stock√©es sous une autre cl√©), on les importe.
      if (!teacherLists.length) {
        const alt = safeParse('voc-app-lists-prof', []);
        if (alt && alt.length) teacherLists = alt;
      }
      teacherLists = ensureDefaultPresence(teacherLists);
      saveTeacherLists();
    }

    function saveTeacherLists() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(teacherLists));
    }

    function loadPublishedLists() {
      lists = safeParse(PUBLISHED_KEY, []);
      if (!lists.length) {
        lists = cloneLists(teacherLists.length ? teacherLists : [defaultList]);
      }
      lists = ensureDefaultPresence(lists);
      savePublishedLists();
    }

    function savePublishedLists() {
      localStorage.setItem(PUBLISHED_KEY, JSON.stringify(lists));
    }

    function loadNotes() {
      wordNotes = safeParse(NOTES_KEY, {});
      // Migration: ancien format string -> objet { note }
      Object.keys(wordNotes).forEach((listId) => {
        Object.keys(wordNotes[listId]).forEach((idx) => {
          const val = wordNotes[listId][idx];
          if (typeof val === 'string') {
            wordNotes[listId][idx] = { note: val };
          }
        });
      });
      saveNotes();
    }

    function saveNotes() {
      localStorage.setItem(NOTES_KEY, JSON.stringify(wordNotes));
    }

    function getFolders() {
      const folders = new Set();
      lists.forEach((l) => folders.add(l.folder || 'Sans dossier'));
      return Array.from(folders);
    }

    function renderFolderFilter() {
      const folders = getFolders();
      folderFilter.innerHTML = '';
      const allOpt = document.createElement('option');
      allOpt.value = 'all';
      allOpt.textContent = 'Tous les dossiers';
      folderFilter.appendChild(allOpt);
      folders.forEach((folder) => {
        const opt = document.createElement('option');
        opt.value = folder;
        opt.textContent = folder;
        folderFilter.appendChild(opt);
      });
      folderFilter.value = currentFolderFilter;
    }

    function renderListSelector() {
      const visibleLists = lists.filter((l) => currentFolderFilter === 'all' || (l.folder || 'Sans dossier') === currentFolderFilter);
      listSelector.innerHTML = '';
      if (!visibleLists.length) {
        listMeta.textContent = 'Aucune liste dans ce dossier.';
        startButton.disabled = true;
        selectionCounter.textContent = '0 mot(s) s√©lectionn√©(s) ¬∑ min 4';
        wordSelection.innerHTML = '';
        selectionState = new Map();
        return;
      }
      visibleLists.forEach((list) => {
        const option = document.createElement('option');
        option.value = list.id;
        option.textContent = `${list.name} (${list.words.length} mots)`;
        listSelector.appendChild(option);
      });
      if (!visibleLists.find((l) => l.id === currentListId)) {
        currentListId = visibleLists[0].id;
      }
      listSelector.value = currentListId;
      updateListMeta();
    }

    function updateListMeta() {
      const current = lists.find((l) => l.id === currentListId);
      if (!current) {
        listMeta.textContent = 'Aucune liste dans ce dossier.';
        return;
      }
      const folderLabel = current.folder ? `Dossier : ${current.folder} ¬∑ ` : '';
      listMeta.textContent = `${folderLabel}${current.words.length} mot(s) disponible(s). Active = passif + actif.`;
    }

    function setStatus(el, message, success = true) {
      if (!el) return;
      el.textContent = message || '';
      el.style.color = message ? (success ? '#166534' : '#b91c1c') : '';
    }

    function loadGithubConfig() {
      const parsed = safeParse(GITHUB_CONF_KEY, null);
      if (parsed) githubConfig = { ...githubConfig, ...parsed };
      if (githubOwnerInput) githubOwnerInput.value = githubConfig.owner || '';
      if (githubRepoInput) githubRepoInput.value = githubConfig.repo || '';
      if (githubBranchInput) githubBranchInput.value = githubConfig.branch || 'main';
      if (githubPathInput) githubPathInput.value = githubConfig.path || 'lists.json';
      if (githubTokenInput) githubTokenInput.value = githubConfig.token || '';
    }

    function saveGithubConfig() {
      githubConfig.owner = (githubOwnerInput.value || '').trim();
      githubConfig.repo = (githubRepoInput.value || '').trim();
      githubConfig.branch = (githubBranchInput.value || '').trim() || 'main';
      githubConfig.path = (githubPathInput.value || '').trim() || 'lists.json';
      githubConfig.token = (githubTokenInput.value || '').trim();
      localStorage.setItem(GITHUB_CONF_KEY, JSON.stringify(githubConfig));
      setStatus(syncStatus, 'Configuration GitHub sauvegard√©e.');
    }

    async function fetchLocalLists() {
      try {
        const res = await fetch('./lists.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('local_fetch_failed');
        const payload = await res.json();
        if (!payload || !Array.isArray(payload.lists)) throw new Error('local_bad_payload');
        return payload;
      } catch (e) {
        return null;
      }
    }

    function githubContentUrl() {
      return `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${githubConfig.path}?ref=${githubConfig.branch}`;
    }

    async function fetchRemoteLists() {
      if (!githubConfig.owner || !githubConfig.repo || !githubConfig.path) throw new Error('missing_conf');
      const res = await fetch(githubContentUrl(), {
        headers: githubConfig.token ? { Authorization: `Bearer ${githubConfig.token}` } : {}
      });
      if (res.status === 404) throw new Error('not_found');
      if (!res.ok) throw new Error('fetch_failed');
      const body = await res.json();
      if (!body.content) throw new Error('bad_payload');
      const decoded = decodeURIComponent(escape(atob(body.content)));
      const payload = JSON.parse(decoded);
      return { payload, sha: body.sha };
    }

    async function pushRemoteLists(payload) {
      if (!githubConfig.owner || !githubConfig.repo || !githubConfig.path || !githubConfig.token) {
        throw new Error('missing_conf');
      }
      // Fetch current sha to avoid conflicts
      let currentSha = null;
      try {
        const metaRes = await fetch(githubContentUrl(), {
          headers: { Authorization: `Bearer ${githubConfig.token}` }
        });
        if (metaRes.ok) {
          const meta = await metaRes.json();
          currentSha = meta.sha;
        }
      } catch (e) {
        // ignore
      }
      const content = toBase64(JSON.stringify(payload, null, 2));
      const res = await fetch(githubContentUrl(), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${githubConfig.token}` },
        body: JSON.stringify({
          message: 'Update vocab lists',
          content,
          branch: githubConfig.branch || 'main',
          sha: currentSha || undefined
        })
      });
      if (!res.ok) throw new Error('push_failed');
    }

    function getRemotePayload() {
      return {
        version: 1,
        updatedAt: new Date().toISOString(),
        lists: cloneLists(lists)
      };
    }

    function applyRemotePayload(payload, label = 'source') {
      if (!payload || !Array.isArray(payload.lists)) return false;
      lists = ensureDefaultPresence(cloneLists(payload.lists || []));
      teacherLists = cloneLists(lists);
      saveTeacherLists();
      savePublishedLists();
      if (!lists.find((l) => l.id === currentListId) && lists.length) {
        currentListId = lists[0].id;
      }
      cleanupNotes();
      renderFolderFilter();
      renderListSelector();
      renderExistingLists();
      renderWordSelection();
      setStatus(syncStatus, `Listes charg√©es depuis ${label}.`);
      return true;
    }

    function cleanupNotes() {
      const validIds = new Set(lists.map((l) => l.id));
      Object.keys(wordNotes).forEach((id) => {
        if (!validIds.has(id)) delete wordNotes[id];
      });
      saveNotes();
    }

    function publishListsFromTeacher(silent = false) {
      lists = ensureDefaultPresence(cloneLists(teacherLists));
      savePublishedLists();
      if (!lists.find((l) => l.id === currentListId) && lists.length) {
        currentListId = lists[0].id;
      }
      cleanupNotes();
      renderFolderFilter();
      renderListSelector();
      renderWordSelection();
      if (!silent) pushRemoteSilently();
    }

    async function pushRemoteSilently() {
      if (!githubConfig.token || !githubConfig.owner || !githubConfig.repo || !githubConfig.path) {
        setStatus(syncStatus, 'Config GitHub manquante pour pousser.', false);
        return;
      }
      try {
        await pushRemoteLists(getRemotePayload());
        setStatus(syncStatus, 'Synchronis√© sur GitHub.');
      } catch (e) {
        setStatus(syncStatus, 'Synchronisation GitHub impossible.', false);
      }
    }

    async function syncFromGithub() {
      if (!githubConfig.owner || !githubConfig.repo || !githubConfig.path) {
        setStatus(syncStatus, 'Config GitHub incompl√®te, utilisation locale.', false);
        publishListsFromTeacher(true);
        renderExistingLists();
        return;
      }
      try {
        setStatus(syncStatus, 'Chargement depuis GitHub...');
        const { payload } = await fetchRemoteLists();
        applyRemotePayload(payload, 'GitHub');
      } catch (e) {
        setStatus(syncStatus, 'Impossible de charger GitHub, utilisation locale.', false);
        publishListsFromTeacher(true);
        renderExistingLists();
      }
    }

    function getTeacherCode() {
      const stored = localStorage.getItem(TEACHER_CODE_KEY);
      return stored && stored.trim().length ? stored : 'prof';
    }

    function renderTeacherAccess() {
      if (!teacherLockedCard || !teacherContent) return;
      teacherLockedCard.style.display = teacherUnlocked ? 'none' : 'block';
      teacherContent.style.display = teacherUnlocked ? 'block' : 'none';
      if (!teacherUnlocked && teacherLockStatus) {
        setStatus(teacherLockStatus, '');
      }
      if (!teacherUnlocked) teacherCodeInput.value = '';
    }

    function tryUnlockTeacher() {
      const code = (teacherCodeInput.value || '').trim();
      if (!code) {
        setStatus(teacherLockStatus, 'Ajoute le code prof.', false);
        return;
      }
      if (code === getTeacherCode()) {
        teacherUnlocked = true;
        setStatus(teacherLockStatus, 'Espace prof d√©verrouill√©.', true);
        renderTeacherAccess();
      } else {
        setStatus(teacherLockStatus, 'Code incorrect.', false);
      }
    }

    function lockTeacher() {
      teacherUnlocked = false;
      renderTeacherAccess();
    }

    function renderExistingLists() {
      existingListsEl.innerHTML = '';
      teacherLists.forEach((list) => {
        const row = document.createElement('div');
        row.className = 'list-item';
        const meta = document.createElement('div');
        meta.className = 'list-meta';
        const title = document.createElement('div');
        title.innerHTML = `<strong>${list.name}</strong><div class="muted" style="font-size:13px;">${list.words.length} mot(s) ¬∑ ${list.folder || 'Sans dossier'}</div>`;
        meta.appendChild(title);
        const actions = document.createElement('div');
        actions.className = 'button-row';
        const editBtn = document.createElement('button');
        editBtn.className = 'chip';
        editBtn.textContent = '√âditer';
        editBtn.addEventListener('click', () => loadListInForm(list.id));
        actions.appendChild(editBtn);

        const duplicateBtn = document.createElement('button');
        duplicateBtn.className = 'chip';
        duplicateBtn.textContent = 'Dupliquer';
        duplicateBtn.addEventListener('click', () => duplicateList(list.id));
        actions.appendChild(duplicateBtn);

        if (list.id !== defaultList.id) {
          const del = document.createElement('button');
          del.className = 'chip';
          del.textContent = 'Supprimer';
          del.addEventListener('click', () => deleteList(list.id));
          actions.appendChild(del);
        } else {
          const base = document.createElement('div');
          base.className = 'badge';
          base.textContent = 'Base';
          actions.appendChild(base);
        }
        row.appendChild(meta);
        row.appendChild(actions);
        existingListsEl.appendChild(row);
      });
    }

    function deleteList(id) {
      teacherLists = teacherLists.filter((l) => l.id !== id);
      if (currentListId === id) currentListId = defaultList.id;
      if (editingListId === id) exitEditMode();
      delete wordNotes[id];
      saveNotes();
      saveTeacherLists();
      publishListsFromTeacher(false);
      renderExistingLists();
    }

    function parseRawList(raw) {
      const lines = raw.split(/\n/).map((l) => l.trim()).filter(Boolean);
      const parsed = [];
      lines.forEach((line) => {
        const parts = line.split(/\t|;|,/);
        if (parts.length >= 2) {
          const french = parts[0].trim();
          const german = parts[1].trim();
          if (french && german) parsed.push({ french, german });
        }
      });
      return parsed;
    }

    function addList(name, words, folder) {
      const id = 'list-' + Date.now();
      teacherLists.push({ id, name, words, folder: folder || 'Sans dossier' });
      currentListId = id;
      saveTeacherLists();
      publishListsFromTeacher(false);
      renderExistingLists();
      exitEditMode();
    }

    function updateList(id, name, words, folder) {
      const target = teacherLists.find((l) => l.id === id);
      if (!target) return;
      target.name = name;
      target.folder = folder || 'Sans dossier';
      target.words = words;
      currentListId = id;
      saveTeacherLists();
      publishListsFromTeacher(false);
      renderExistingLists();
      exitEditMode();
    }

    function duplicateList(id) {
      const target = teacherLists.find((l) => l.id === id);
      if (!target) return;
      const cloneName = `${target.name} (copie)`;
      addList(cloneName, target.words.slice(), target.folder);
    }

    function loadListInForm(id) {
      const target = teacherLists.find((l) => l.id === id);
      if (!target) return;
      editingListId = id;
      listNameInput.value = target.name;
      folderInput.value = target.folder || 'Sans dossier';
      listRawInput.value = target.words.map((w) => `${w.french};${w.german}`).join('\\n');
      saveListButton.textContent = 'Mettre √† jour la liste';
      cancelEditButton.style.display = 'inline-flex';
      editStatus.textContent = `√âdition de la liste : ${target.name}`;
    }

    function exitEditMode() {
      editingListId = null;
      listNameInput.value = '';
      listRawInput.value = '';
      folderInput.value = '';
      saveListButton.textContent = 'Enregistrer la liste';
      cancelEditButton.style.display = 'none';
      editStatus.textContent = '';
    }

    function renderWordSelection() {
      const list = lists.find((l) => l.id === currentListId);
      if (!list) return;
      selectionState = new Map();
      wordSelection.innerHTML = '';
      list.words.forEach((word, index) => {
        selectionState.set(index, { passive: false, active: false });
        const card = document.createElement('div');
        card.className = 'word-card';
        const text = document.createElement('div');
        text.className = 'word-text';
        text.innerHTML = `<div class="german">${word.german}</div><div class="french">${word.french}</div>`;

        const chipGroup = document.createElement('div');
        chipGroup.className = 'chip-group';

        const passiveChip = document.createElement('button');
        passiveChip.className = 'chip';
        passiveChip.textContent = 'P';
        passiveChip.dataset.index = index;
        passiveChip.dataset.type = 'passive';
        passiveChip.addEventListener('click', (e) => { e.stopPropagation(); toggleSelection(index, 'passive', passiveChip, activeChip); });

        const activeChip = document.createElement('button');
        activeChip.className = 'chip';
        activeChip.textContent = 'A';
        activeChip.dataset.index = index;
        activeChip.dataset.type = 'active';
        activeChip.addEventListener('click', (e) => { e.stopPropagation(); toggleSelection(index, 'active', passiveChip, activeChip); });

        chipGroup.appendChild(passiveChip);
        chipGroup.appendChild(activeChip);

        card.appendChild(text);
      card.appendChild(chipGroup);
      wordSelection.appendChild(card);

      card.addEventListener('click', () => {
        if (colorPaletteEnabled) {
          if (currentColorMode) applyTag(list.id, index, currentColorMode, card);
          return;
        }
        cycleNote(list.id, index, card);
      });

        applyTag(list.id, index, getStoredTag(list.id, index), card, true);
        applyNoteClasses(list.id, index, card);
        syncSelectionState(index, passiveChip, activeChip);
      });
      updateStartButtonState();
    }

    function toggleSelection(index, type, passiveChip, activeChip) {
      const state = selectionState.get(index) || { passive: false, active: false };
      if (type === 'passive') {
        state.passive = !state.passive;
        if (!state.passive) state.active = false;
      } else {
        state.active = !state.active;
        state.passive = state.active ? true : state.passive;
      }
      selectionState.set(index, state);
      passiveChip.classList.toggle('active', state.passive);
      activeChip.classList.toggle('active', state.active);
      updateStartButtonState();
    }

    function syncSelectionState(index, passiveChip, activeChip) {
      const state = selectionState.get(index) || { passive: false, active: false };
      passiveChip.classList.toggle('active', state.passive);
      activeChip.classList.toggle('active', state.active);
    }

    function ensureNoteObj(listId, index) {
      wordNotes[listId] = wordNotes[listId] || {};
      if (!wordNotes[listId][index]) wordNotes[listId][index] = {};
      if (typeof wordNotes[listId][index] === 'string') {
        wordNotes[listId][index] = { note: wordNotes[listId][index] };
      }
      return wordNotes[listId][index];
    }

    function cycleNote(listId, index, card) {
      const entry = ensureNoteObj(listId, index);
      if (entry.note === 'easy') entry.note = 'hard';
      else if (entry.note === 'hard') entry.note = null;
      else entry.note = 'easy';
      if (!entry.note && !entry.tag) delete wordNotes[listId][index];
      saveNotes();
      applyNoteClasses(listId, index, card);
    }

    function applyNoteClasses(listId, index, card) {
      const entry = wordNotes[listId] ? wordNotes[listId][index] : null;
      const note = entry ? entry.note : null;
      card.classList.toggle('note-easy', note === 'easy');
      card.classList.toggle('note-hard', note === 'hard');
    }

    const tagColors = {
      blue: '#0ea5e9',
      pink: '#ec4899',
      green: '#22c55e',
      red: '#ef4444',
      black: '#0f172a'
    };

    function applyTag(listId, index, tag, card, skipSave) {
      const existingEntry = wordNotes[listId] ? wordNotes[listId][index] : null;
      if (tag === null || tag === undefined) tag = existingEntry ? existingEntry.tag || null : null;
      if (tag === 'black') tag = null;
      if (!tag && !existingEntry && skipSave) return;
      const entry = ensureNoteObj(listId, index);
      entry.tag = tag;
      if (!entry.note && !entry.tag) delete wordNotes[listId][index];
      if (!skipSave) saveNotes();
      const text = card.querySelector('.word-text');
      if (text) {
        const color = tag ? tagColors[tag] : null;
        text.style.color = color || 'inherit';
      }
    }

    function getStoredTag(listId, index) {
      const entry = wordNotes[listId] ? wordNotes[listId][index] : null;
      return entry ? entry.tag || null : null;
    }

    function updateSelectionCounter() {
      const { passiveCount } = getSelectedWords();
      selectionCounter.textContent = `${passiveCount} mot(s) s√©lectionn√©(s) ¬∑ min 4`;
    }

    function updateStartButtonState() {
      const { passiveCount } = getSelectedWords();
      startButton.disabled = passiveCount < 4;
      const remaining = Math.max(0, 4 - passiveCount);
      startButton.textContent = passiveCount < 4 ? `Lancer (encore ${remaining})` : 'Lancer l\'entra√Ænement';
      updateSelectionCounter();
    }

    function setColorMode(tag) {
      currentColorMode = tag;
      if (!globalTags) return;
      const buttons = Array.from(globalTags.querySelectorAll('.tag-dot'));
      buttons.forEach((btn) => {
        btn.classList.toggle('active', btn.dataset.tag === tag);
      });
    }

    function getSelectedWords() {
      const list = lists.find((l) => l.id === currentListId);
      if (!list) return { passiveWords: [], activeWords: [], passiveCount: 0 };
      const passive = [];
      const active = [];
      selectionState.forEach((state, index) => {
        if (state.passive) passive.push(list.words[index]);
        if (state.active) active.push(list.words[index]);
      });
      return { passiveWords: passive, activeWords: active, passiveCount: passive.length };
    }

    function updateDots(container, total, current, results) {
      container.innerHTML = '';
      for (let i = 0; i < total; i++) {
        const dot = document.createElement('div');
        dot.className = 'dot';
        if (results && results[i] === true) dot.classList.add('success');
        if (results && results[i] === false) dot.classList.add('error');
        if (i < current) dot.classList.add('done');
        if (i === current) dot.classList.add('current');
        container.appendChild(dot);
      }
    }

    function updateProgress(progressEl, labelEl, countEl, current, total, phaseLabel) {
      const percent = Math.min(100, Math.round((current / total) * 100));
      progressEl.style.width = `${percent}%`;
      const displayIndex = Math.min(current + 1, total);
      labelEl.textContent = `${phaseLabel} ¬∑ ${displayIndex} / ${total}`;
      countEl.textContent = `${total - current} restant(s)`;
    }

    function resetGameViews() {
      passiveScreen.style.display = 'none';
      activeScreen.style.display = 'none';
      finalScreen.style.display = 'none';
      selectionCard.style.display = 'block';
      passiveFeedback.textContent = '';
      activeFeedback.textContent = '';
      chunkButtons.innerHTML = '';
      letterButtons.innerHTML = '';
      assembledPassive.textContent = '';
      assembledActive.textContent = '';
      chunkStack = [];
      userChunkInput = '';
      userLetterInput = '';
      passiveResults = [];
      activeResults = [];
      passiveErrorThisRound = false;
      activeErrorThisRound = false;
    }

    function startPassivePhase() {
      phase = 'passive';
      passiveQueue = shuffle([...passiveWords]);
      passiveResults = new Array(passiveQueue.length).fill(null);
      passiveErrorThisRound = false;
      currentIndex = 0;
      selectionCard.style.display = 'none';
      passiveScreen.style.display = 'block';
      activeScreen.style.display = 'none';
      finalScreen.style.display = 'none';
      startTime = Date.now();
      renderPassiveWord();
      passiveScreen.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function renderPassiveWord() {
      if (currentIndex >= passiveQueue.length) {
        if (passiveErrorThisRound) {
          currentIndex = 0;
          passiveErrorThisRound = false;
          passiveFeedback.textContent = 'On recommence tous les mots jusqu‚Äô√† 100% correct.';
          updateDots(passiveDots, passiveWords.length, currentIndex, passiveResults);
          updateProgress(passiveProgress, passiveStepLabel, passiveCount, currentIndex, passiveWords.length, 'Passif');
        } else {
          if (activeWords.length > 0) {
            startActivePhase();
          } else {
            finishSession();
          }
          return;
        }
      }
      const word = passiveQueue[currentIndex];
      germanWordEl.textContent = word.german;
      const { targetNormalized, options } = buildChunks(word.french);
      targetSanitized = targetNormalized;
      userChunkInput = '';
      chunkStack = [];
      assembledPassive.textContent = 'Tape la traduction en fran√ßais';
      chunkButtons.innerHTML = '';
      options.forEach((chunk) => {
        const btn = document.createElement('button');
        btn.className = 'chunk-btn';
        btn.textContent = chunk.replace(/ /g, '‚ê£');
        btn.dataset.raw = chunk;
        btn.addEventListener('click', () => {
          if (btn.classList.contains('used')) return;
          btn.classList.add('used');
          userChunkInput += chunk;
          chunkStack.push({ chunk, btn });
          assembledPassive.textContent = userChunkInput;
        });
        chunkButtons.appendChild(btn);
      });
      updateDots(passiveDots, passiveWords.length, currentIndex, passiveResults);
      updateProgress(passiveProgress, passiveStepLabel, passiveCount, currentIndex, passiveWords.length, 'Passif');
      passiveFeedback.textContent = '';
    }

    function undoChunk() {
      const last = chunkStack.pop();
      if (!last) return;
      const { chunk, btn } = last;
      userChunkInput = userChunkInput.slice(0, -chunk.length);
      btn.classList.remove('used');
      assembledPassive.textContent = userChunkInput || 'Tape la traduction en fran√ßais';
    }

    function validatePassive() {
      const word = passiveQueue[currentIndex];
      const isCorrect = normalizeAnswer(userChunkInput) === targetSanitized;
      passiveResults[currentIndex] = isCorrect;
      if (isCorrect) {
        passiveFeedback.textContent = 'Bien jou√© !';
        passiveFeedback.className = 'feedback success';
      } else {
        passiveFeedback.textContent = `R√©ponse attendue : ${word.french}`;
        passiveFeedback.className = 'feedback error';
        passiveErrorThisRound = true;
      }
      updateDots(passiveDots, passiveWords.length, currentIndex, passiveResults);
      currentIndex++;
      setTimeout(renderPassiveWord, isCorrect ? 300 : 700);
    }

    function startActivePhase() {
      phase = 'active';
      activeQueue = shuffle([...activeWords]);
      activeResults = new Array(activeQueue.length).fill(null);
      activeErrorThisRound = false;
      currentIndex = 0;
      passiveScreen.style.display = 'none';
      activeScreen.style.display = 'block';
      finalScreen.style.display = 'none';
      renderActiveWord();
      activeScreen.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function renderActiveWord() {
      if (currentIndex >= activeQueue.length) {
        if (activeErrorThisRound) {
          currentIndex = 0;
          activeErrorThisRound = false;
          activeFeedback.textContent = 'On recommence tous les mots jusqu‚Äô√† 100% correct.';
          updateDots(activeDots, activeWords.length, currentIndex, activeResults);
          updateProgress(activeProgress, activeStepLabel, activeCount, currentIndex, activeWords.length, 'Actif');
        } else {
          finishSession();
          return;
        }
      }
      const word = activeQueue[currentIndex];
      frenchWordEl.textContent = word.french;
      const { targetNormalized, letters, counts } = buildLetters(word.german);
      targetSanitized = targetNormalized;
      userLetterInput = '';
      letterStack = [];
      assembledActive.textContent = 'Assemble le mot allemand';
      letterButtons.innerHTML = '';
      const buttonCounts = {};
      letters.forEach((letter) => {
        buttonCounts[letter] = (buttonCounts[letter] || 0) + 1;
      });
      letters.forEach((letter) => {
        const btn = document.createElement('button');
        btn.className = 'letter-btn';
        btn.textContent = letter === ' ' ? '‚ê£' : letter;
        btn.dataset.letter = letter;
        btn.dataset.remaining = counts[letter] ? counts[letter] : 1;
        btn.addEventListener('click', () => {
          if (btn.classList.contains('used')) return;
          const remaining = parseInt(btn.dataset.remaining, 10);
          const totalUsed = buttonCounts[letter] - remaining;
          if (totalUsed >= buttonCounts[letter]) return;
          userLetterInput += letter;
          letterStack.push({ letter, btn });
          assembledActive.textContent = userLetterInput;
          btn.dataset.remaining = remaining - 1;
          if (parseInt(btn.dataset.remaining, 10) <= 0) {
            btn.classList.add('used');
            btn.disabled = true;
          }
        });
        letterButtons.appendChild(btn);
      });
      updateDots(activeDots, activeWords.length, currentIndex, activeResults);
      updateProgress(activeProgress, activeStepLabel, activeCount, currentIndex, activeWords.length, 'Actif');
      activeFeedback.textContent = '';
    }

    function eraseLetter() {
      if (!userLetterInput.length) return;
      const last = letterStack.pop();
      userLetterInput = userLetterInput.slice(0, -1);
      if (last && last.btn) {
        let remaining = parseInt(last.btn.dataset.remaining, 10);
        remaining = remaining + 1;
        last.btn.dataset.remaining = remaining;
        last.btn.disabled = false;
        last.btn.classList.remove('used');
      }
      assembledActive.textContent = userLetterInput || 'Assemble le mot allemand';
    }

    function validateActive() {
      const word = activeQueue[currentIndex];
      const isCorrect = normalizeAnswer(userLetterInput) === targetSanitized;
      activeResults[currentIndex] = isCorrect;
      if (isCorrect) {
        activeFeedback.textContent = 'Parfait !';
        activeFeedback.className = 'feedback success';
      } else {
        activeFeedback.textContent = `R√©ponse attendue : ${word.german}`;
        activeFeedback.className = 'feedback error';
        activeErrorThisRound = true;
      }
      updateDots(activeDots, activeWords.length, currentIndex, activeResults);
      currentIndex++;
      setTimeout(renderActiveWord, isCorrect ? 300 : 700);
    }

    function finishSession() {
      phase = 'done';
      passiveScreen.style.display = 'none';
      activeScreen.style.display = 'none';
      finalScreen.style.display = 'block';
      const elapsed = Math.round((Date.now() - startTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      timerResult.textContent = `Temps : ${minutes} min ${seconds < 10 ? '0' : ''}${seconds} sec`;
      const total = passiveWords.length + activeWords.length;
      finalMessage.textContent = `${total} passage(s) valid√©(s). Tu peux rejouer ou changer de liste.`;
    }

    function backToList() {
      phase = 'idle';
      resetGameViews();
      passiveScreen.style.display = 'none';
      activeScreen.style.display = 'none';
      finalScreen.style.display = 'none';
    }

    function clearSelection() {
      selectionState.forEach((state, index) => {
        state.passive = false;
        state.active = false;
        selectionState.set(index, state);
      });
      const chips = document.querySelectorAll('.chip:not(.note-easy):not(.note-hard)');
      chips.forEach((chip) => chip.classList.remove('active'));
      updateStartButtonState();
      setColorMode(null);
    }

    function initTabs() {
      tabButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          tabButtons.forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');
          const tab = btn.dataset.tab;
          teacherTab.classList.toggle('active', tab === 'teacher');
          studentTab.classList.toggle('active', tab === 'student');
        });
      });
      // assure un √©tat initial propre
      teacherTab.classList.remove('active');
      studentTab.classList.add('active');
    }

    function initEvents() {
      if (unlockTeacherBtn) unlockTeacherBtn.addEventListener('click', tryUnlockTeacher);
      if (lockTeacherBtn) lockTeacherBtn.addEventListener('click', lockTeacher);
      if (refreshRemoteBtn) refreshRemoteBtn.addEventListener('click', syncFromGithub);
      if (saveGithubConfigBtn) saveGithubConfigBtn.addEventListener('click', () => {
        saveGithubConfig();
        syncFromGithub();
      });
      if (downloadJsonBtn) downloadJsonBtn.addEventListener('click', () => {
        const payload = getRemotePayload();
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'lists.json';
        a.click();
        URL.revokeObjectURL(url);
        setStatus(syncStatus, 'lists.json t√©l√©charg√©. Commitez-le sur GitHub pour partager.');
      });

      folderFilter.addEventListener('change', () => {
        currentFolderFilter = folderFilter.value;
        renderListSelector();
        renderWordSelection();
      });

      listSelector.addEventListener('change', () => {
        currentListId = listSelector.value;
        updateListMeta();
        renderWordSelection();
      });

      startButton.addEventListener('click', () => {
        const { passiveWords: pWords, activeWords: aWords, passiveCount } = getSelectedWords();
        if (passiveCount < 4) {
          alert('S√©lectionne au moins 4 mots.');
          return;
        }
        passiveWords = pWords;
        activeWords = aWords;
        resetGameViews();
        startPassivePhase();
      });

      clearSelectionButton.addEventListener('click', clearSelection);
      if (globalTags) {
        globalTags.querySelectorAll('.tag-dot').forEach((btn) => {
          btn.addEventListener('click', () => {
            const tag = btn.dataset.tag;
            const nextTag = currentColorMode === tag ? null : tag;
            setColorMode(nextTag);
          });
        });
      }

      if (toggleColorsButton) {
        toggleColorsButton.addEventListener('click', () => {
          colorPaletteEnabled = !colorPaletteEnabled;
          globalTags.classList.toggle('hidden', !colorPaletteEnabled);
          if (!colorPaletteEnabled) {
            setColorMode(null);
          }
        });
        // palette hidden by default
        colorPaletteEnabled = false;
        globalTags.classList.add('hidden');
      }

      document.getElementById('undo-chunk').addEventListener('click', undoChunk);
      document.getElementById('validate-passive').addEventListener('click', validatePassive);
      document.getElementById('back-to-list-passive').addEventListener('click', backToList);

      document.getElementById('erase-letter').addEventListener('click', eraseLetter);
      document.getElementById('validate-active').addEventListener('click', validateActive);
      document.getElementById('back-to-list-active').addEventListener('click', backToList);

      document.getElementById('restart').addEventListener('click', backToList);

      saveListButton.addEventListener('click', () => {
        const name = listNameInput.value.trim();
        const folder = folderInput.value.trim() || 'Sans dossier';
        const parsed = parseRawList(listRawInput.value);
        if (!name) { alert('Ajoute un nom de liste.'); return; }
        if (!parsed.length) { alert('Ajoute au moins une ligne avec fran√ßais + allemand.'); return; }
        if (editingListId) {
          updateList(editingListId, name, parsed, folder);
        } else {
          addList(name, parsed, folder);
        }
      });

      resetFormButton.addEventListener('click', () => {
        exitEditMode();
      });

      cancelEditButton.addEventListener('click', exitEditMode);
    }

    async function bootstrap() {
      try {
        loadTeacherLists();
        loadGithubConfig();
        loadPublishedLists();
        teacherLists = cloneLists(lists);
        saveTeacherLists();
        loadNotes();
        cleanupNotes();
        renderFolderFilter();
        renderListSelector();
        renderExistingLists();
        renderWordSelection();
        renderTeacherAccess();
        initTabs();
        initEvents();
        const localPayload = await fetchLocalLists();
        if (localPayload) applyRemotePayload(localPayload, 'lists.json local');
        await syncFromGithub();
        if (!lists.length) {
          lists = ensureDefaultPresence([]);
          savePublishedLists();
          renderFolderFilter();
          renderListSelector();
          renderWordSelection();
        }
      } catch (err) {
        console.error('Erreur au d√©marrage', err);
        setStatus(syncStatus, 'Erreur de chargement. Donn√©es locales utilis√©es.', false);
        renderTeacherAccess();
        initTabs();
        initEvents();
      }
    }

    bootstrap().catch((e) => {
      console.error('Erreur au d√©marrage', e);
      setStatus(syncStatus, 'Erreur au d√©marrage.', false);
    });
  </script>
</body>
</html>
